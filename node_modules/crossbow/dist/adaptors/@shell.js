"use strict";
var _npm_1 = require("./@npm");
var task_resolve_1 = require("../task.resolve");
var task_utils_1 = require("../task.utils");
var file = require("../file.utils");
var merge = require("../../lodash.custom").merge;
var debug = require("debug")("cb:@shell");
function default_1(task, trigger) {
    return function (opts, ctx, done) {
        var args = (function () {
            if (task.origin === task_resolve_1.TaskOriginTypes.FileSystem) {
                try {
                    var contentFromDisk = file.readFileContent(task.externalTasks[0]);
                    return _npm_1.getArgs(contentFromDisk);
                }
                catch (e) {
                    return {
                        errors: [e]
                    };
                }
            }
            return _npm_1.getArgs(task.command);
        })();
        if (args.errors.length) {
            done(args.errors[0]);
            return;
        }
        var stdio = _npm_1.getStdio(trigger);
        var cbEnv = task_utils_1.getCBEnv(trigger);
        var ctxEnv = task_utils_1.getContextEnv(trigger, ctx);
        var userEnv = _npm_1.getEnv(process, trigger.config);
        var env = merge({}, process.env, userEnv, cbEnv, task.env, trigger.config.env, ctxEnv);
        debug("running %s", args.cmd);
        var emitter = _npm_1.runCommand(args.cmd, {
            cwd: trigger.config.cwd,
            env: env,
            stdio: stdio
        });
        _npm_1.handleExit(emitter, done);
        return function tearDownShellAdaptor() {
            _npm_1.teardown(emitter, task);
        };
    };
}
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = default_1;
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQHNoZWxsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2FkYXB0b3JzL0BzaGVsbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQ0EsK0JBQWdHO0FBQ2hHLGdEQUFzRDtBQUN0RCw0Q0FBc0Q7QUFDdEQsb0NBQXNDO0FBQ3RDLElBQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLEtBQUssQ0FBQztBQUNuRCxJQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUM7QUFFNUMsbUJBQXlCLElBQVUsRUFBRSxPQUF1QjtJQUV4RCxNQUFNLENBQUMsVUFBVSxJQUFJLEVBQUUsR0FBRyxFQUFFLElBQUk7UUFFNUIsSUFBTSxJQUFJLEdBQUcsQ0FBQztZQUNWLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLEtBQUssOEJBQWUsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO2dCQUM3QyxJQUFJLENBQUM7b0JBQ0QsSUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ3BFLE1BQU0sQ0FBQyxjQUFPLENBQUMsZUFBZSxDQUFDLENBQUM7Z0JBQ3BDLENBQUM7Z0JBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDVCxNQUFNLENBQUM7d0JBQ0gsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDO3FCQUNkLENBQUM7Z0JBQ04sQ0FBQztZQUNMLENBQUM7WUFDRCxNQUFNLENBQUMsY0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNqQyxDQUFDLENBQUMsRUFBRSxDQUFDO1FBR0wsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ3JCLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDckIsTUFBTSxDQUFDO1FBQ1gsQ0FBQztRQUVELElBQU0sS0FBSyxHQUFLLGVBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNsQyxJQUFNLEtBQUssR0FBSyxxQkFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ2xDLElBQU0sTUFBTSxHQUFJLDBCQUFhLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQzVDLElBQU0sT0FBTyxHQUFHLGFBQU0sQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ2hELElBQU0sR0FBRyxHQUFPLEtBQUssQ0FBQyxFQUFFLEVBQUUsT0FBTyxDQUFDLEdBQUcsRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFFN0YsS0FBSyxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFOUIsSUFBTSxPQUFPLEdBQUcsaUJBQVUsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFO1lBQ2pDLEdBQUcsRUFBRSxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUc7WUFDdkIsR0FBRyxFQUFFLEdBQUc7WUFDUixLQUFLLEVBQUUsS0FBSztTQUNmLENBQUMsQ0FBQztRQUVILGlCQUFVLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBRTFCLE1BQU0sQ0FBQztZQUNILGVBQVEsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDNUIsQ0FBQyxDQUFDO0lBQ04sQ0FBQyxDQUFDO0FBQ04sQ0FBQzs7QUE1Q0QsNEJBNENDO0FBQUEsQ0FBQyJ9