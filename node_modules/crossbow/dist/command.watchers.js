"use strict";
var command_run_1 = require("./command.run");
var Immutable = require("immutable");
var Rx = require("rx");
var watch_utils_1 = require("./watch.utils");
var watch_resolve_1 = require("./watch.resolve");
var watch_runner_1 = require("./watch.runner");
var reporter_resolve_1 = require("./reporter.resolve");
function execute(trigger) {
    var input = trigger.input, config = trigger.config, reporter = trigger.reporter;
    var topLevelWatchers = watch_utils_1.stripBlacklisted(Object.keys(input.watch));
    if (!topLevelWatchers.length) {
        reporter({
            type: reporter_resolve_1.ReportTypes.NoWatchersAvailable
        });
        return Rx.Observable.just({
            setup: {
                errors: [{ type: reporter_resolve_1.ReportTypes.NoWatchersAvailable }]
            }
        });
    }
    var watchTasks = watch_resolve_1.resolveWatchTasks(topLevelWatchers, trigger);
    var runners = watch_runner_1.createWatchRunners(watchTasks, trigger);
    /**
     * Never continue if any runners are invalid
     */
    if (runners.invalid.length) {
        /**
         * Now log the invalid runners
         */
        runners.invalid.forEach(function (runner) {
            reporter({ type: reporter_resolve_1.ReportTypes.WatchTaskTasksErrors, data: { tasks: runner._tasks.all, runner: runner, config: config } });
        });
        return Rx.Observable.just({
            setup: {
                watchTasks: watchTasks,
                runners: runners,
                errors: [{ type: reporter_resolve_1.ReportTypes.WatchTaskTasksErrors }]
            }
        });
    }
    return Rx.Observable.just({
        setup: {
            watchTasks: watchTasks,
            runners: runners,
            errors: []
        }
    });
}
function handleIncomingWatchersCommand(cli, input, config, reporter) {
    return execute({
        shared: new Rx.BehaviorSubject(Immutable.Map({})),
        cli: cli,
        input: input,
        config: config,
        reporter: reporter,
        type: command_run_1.TriggerTypes.command
    });
}
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = handleIncomingWatchersCommand;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tbWFuZC53YXRjaGVycy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9jb21tYW5kLndhdGNoZXJzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFDQSw2Q0FBMkQ7QUFHM0QscUNBQXdDO0FBQ3hDLHVCQUEwQjtBQUMxQiw2Q0FBK0M7QUFDL0MsaURBQThEO0FBQzlELCtDQUFnRTtBQUNoRSx1REFBK0M7QUFZL0MsaUJBQWlCLE9BQXVCO0lBQzdCLElBQUEscUJBQUssRUFBRSx1QkFBTSxFQUFFLDJCQUFRLENBQVk7SUFDMUMsSUFBTSxnQkFBZ0IsR0FBWSw4QkFBZ0IsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO0lBRTdFLEVBQUUsQ0FBQyxDQUFDLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztRQUMzQixRQUFRLENBQUM7WUFDTCxJQUFJLEVBQUUsOEJBQVcsQ0FBQyxtQkFBbUI7U0FDeEMsQ0FBQyxDQUFDO1FBQ0gsTUFBTSxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDO1lBQ3RCLEtBQUssRUFBRTtnQkFDSCxNQUFNLEVBQUUsQ0FBQyxFQUFDLElBQUksRUFBRSw4QkFBVyxDQUFDLG1CQUFtQixFQUFDLENBQUM7YUFDcEQ7U0FDSixDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQsSUFBTSxVQUFVLEdBQUcsaUNBQWlCLENBQUMsZ0JBQWdCLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDaEUsSUFBTSxPQUFPLEdBQU0saUNBQWtCLENBQUMsVUFBVSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBRTNEOztPQUVHO0lBQ0gsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1FBQ3pCOztXQUVHO1FBQ0gsT0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsVUFBQSxNQUFNO1lBQzFCLFFBQVEsQ0FBQyxFQUFDLElBQUksRUFBRSw4QkFBVyxDQUFDLG9CQUFvQixFQUFFLElBQUksRUFBRSxFQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxNQUFNLFFBQUEsRUFBRSxNQUFNLFFBQUEsRUFBQyxFQUFDLENBQUMsQ0FBQztRQUN6RyxDQUFDLENBQUMsQ0FBQztRQUVILE1BQU0sQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQztZQUN0QixLQUFLLEVBQUU7Z0JBQ0gsVUFBVSxZQUFBO2dCQUNWLE9BQU8sU0FBQTtnQkFDUCxNQUFNLEVBQUUsQ0FBQyxFQUFDLElBQUksRUFBRSw4QkFBVyxDQUFDLG9CQUFvQixFQUFDLENBQUM7YUFDckQ7U0FDSixDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQsTUFBTSxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDO1FBQ3RCLEtBQUssRUFBRTtZQUNILFVBQVUsWUFBQTtZQUNWLE9BQU8sU0FBQTtZQUNQLE1BQU0sRUFBRSxFQUFFO1NBQ2I7S0FDSixDQUFDLENBQUM7QUFDUCxDQUFDO0FBRUQsdUNBQXNELEdBQVEsRUFBRSxLQUFvQixFQUFFLE1BQTZCLEVBQUUsUUFBMEI7SUFDM0ksTUFBTSxDQUFDLE9BQU8sQ0FBQztRQUNYLE1BQU0sRUFBRSxJQUFJLEVBQUUsQ0FBQyxlQUFlLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNqRCxHQUFHLEtBQUE7UUFDSCxLQUFLLE9BQUE7UUFDTCxNQUFNLFFBQUE7UUFDTixRQUFRLFVBQUE7UUFDUixJQUFJLEVBQUUsMEJBQVksQ0FBQyxPQUFPO0tBQzdCLENBQUMsQ0FBQztBQUNQLENBQUM7O0FBVEQsZ0RBU0MifQ==