"use strict";
var Immutable = require("immutable");
var fromJS = Immutable.fromJS, Map = Immutable.Map;
var Rx = require("rx");
/**
 * A task context is just an Immutable Map of key=>value pairs
 * that may be used to provide addition context to the task running
 * environment. This is especially useful in situations where you need
 * to do something that MUST block the task running altogether. An example
 * would be hashing files/directories to determine if a task/group of tasks should
 * run.
 */
function getContext(tasks, trigger) {
    /**
     * Define a list of async actions
     * that must complete before any tasks are executed
     * @type {Array}
     */
    var preExecutionTasks = [
        require("./command.run.pre-execution").createHashes
    ];
    /**
     * Now wrap each Function in an observable
     * @type {Rx.Observable<PreExecutionTask>[]}
     */
    var observables = preExecutionTasks.map(function (fn) {
        return Rx.Observable.create(function (obs) {
            fn(tasks, trigger).subscribe(obs);
        });
    });
    /**
     * Run each item in sequence
     * finally producing an Immutable Map from all the gathered values
     */
    return Rx.Observable
        .from(observables)
        .concatAll()
        .toArray()
        .map(function (xs) {
        return (_a = Map({})).mergeDeep.apply(_a, xs.map(function (x) { return fromJS(x); }));
        var _a;
    });
}
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = getContext;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tbWFuZC5ydW4uY29udGV4dC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9jb21tYW5kLnJ1bi5jb250ZXh0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFDQSxxQ0FBd0M7QUFFakMsSUFBQSx5QkFBTSxFQUFFLG1CQUFHLENBQWM7QUFFaEMsdUJBQTBCO0FBSTFCOzs7Ozs7O0dBT0c7QUFDSCxvQkFBbUMsS0FBYSxFQUFFLE9BQXVCO0lBRXJFOzs7O09BSUc7SUFDSCxJQUFNLGlCQUFpQixHQUE0QjtRQUMvQyxPQUFPLENBQUMsNkJBQTZCLENBQUMsQ0FBQyxZQUFZO0tBQ3RELENBQUM7SUFFRjs7O09BR0c7SUFDSCxJQUFNLFdBQVcsR0FBRyxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsVUFBQyxFQUFFO1FBQ3pDLE1BQU0sQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEdBQUc7WUFDckMsRUFBRSxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDdEMsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDLENBQUMsQ0FBQztJQUVIOzs7T0FHRztJQUNILE1BQU0sQ0FBQyxFQUFFLENBQUMsVUFBVTtTQUNmLElBQUksQ0FBQyxXQUFXLENBQUM7U0FDakIsU0FBUyxFQUFFO1NBQ1gsT0FBTyxFQUFFO1NBQ1QsR0FBRyxDQUFDLFVBQUEsRUFBRTtRQUNILE1BQU0sQ0FBQyxDQUFBLEtBQUEsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFBLENBQUMsU0FBUyxXQUFJLEVBQUUsQ0FBQyxHQUFHLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQVQsQ0FBUyxDQUFDLEVBQUU7O0lBQ3hELENBQUMsQ0FBQyxDQUFDO0FBQ1gsQ0FBQzs7QUFoQ0QsNkJBZ0NDIn0=