"use strict";
var task_utils_1 = require("./task.utils");
var debug = require("debug")("cb:command.run");
var Rx = require("rx");
var Immutable = require("immutable");
var logger_1 = require("./logger");
var task_resolve_1 = require("./task.resolve");
var command_run_1 = require("./command.run");
var task_list_1 = require("./reporters/task.list");
var reporter_resolve_1 = require("./reporter.resolve");
var defaultReporter_1 = require("./reporters/defaultReporter");
function prompt(cli, input, config, reporter) {
    var possibleSelection = cli.input.slice(1);
    var inquirer = require("inquirer");
    var allTaskNames = task_utils_1.getPossibleTaskNames(input);
    var filtered = possibleSelection.reduce(function (acc, name) {
        return acc.concat(allTaskNames
            .filter(function (x) { return x.indexOf(name + ":") === 0; }));
    }, []);
    var taskNamesToShow = (function () {
        if (filtered.length)
            return filtered;
        return allTaskNames;
    })();
    var resolved = task_resolve_1.resolveTasks(taskNamesToShow, {
        shared: new Rx.BehaviorSubject(Immutable.Map({})),
        cli: cli,
        input: input,
        config: config,
        reporter: reporter,
        type: command_run_1.TriggerTypes.command
    });
    if (resolved.invalid.length) {
        reporter({ type: reporter_resolve_1.ReportTypes.TaskTree, data: { tasks: resolved.all, config: config, title: "Available tasks:" } });
        return Rx.Observable.empty();
    }
    else {
        var taskSelect = {
            type: "checkbox",
            message: "Select Tasks to run with <space>",
            name: "tasks",
            choices: getTaskList(resolved.valid),
            validate: function (answer) {
                if (answer.length < 1) {
                    return "You must choose at least one task";
                }
                return true;
            }
        };
        return Rx.Observable.fromPromise(inquirer.prompt(taskSelect));
    }
}
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = prompt;
function getTaskList(tasks) {
    var topLevelTasks = tasks.filter(function (x) { return !task_utils_1.isInternal(x.baseTaskName); });
    var longest = task_utils_1.getLongestTaskName(topLevelTasks);
    var col = task_list_1.twoCol(topLevelTasks, longest);
    return col.map(function (tuple, i) {
        return {
            name: logger_1.compile(tuple[0] + " " + tuple[1]),
            value: (function () {
                return defaultReporter_1.getCleanLabel(topLevelTasks[i]);
            })()
        };
    });
}
exports.getTaskList = getTaskList;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tbWFuZC5ydW4uaW50ZXJhY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvY29tbWFuZC5ydW4uaW50ZXJhY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLDJDQUFrRjtBQUNsRixJQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztBQUNqRCx1QkFBMEI7QUFDMUIscUNBQXdDO0FBQ3hDLG1DQUFpQztBQUdqQywrQ0FBdUQ7QUFDdkQsNkNBQTJDO0FBRTNDLG1EQUE2QztBQUM3Qyx1REFBK0M7QUFDL0MsK0RBQW9FO0FBTXBFLGdCQUErQixHQUFRLEVBQUUsS0FBb0IsRUFBRSxNQUE2QixFQUFFLFFBQTBCO0lBRXBILElBQU0saUJBQWlCLEdBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDOUMsSUFBTSxRQUFRLEdBQWEsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQy9DLElBQU0sWUFBWSxHQUFTLGlDQUFvQixDQUFDLEtBQUssQ0FBQyxDQUFDO0lBRXZELElBQU0sUUFBUSxHQUFhLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxVQUFDLEdBQUcsRUFBRSxJQUFJO1FBQzFELE1BQU0sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLFlBQVk7YUFDekIsTUFBTSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxDQUFDLE9BQU8sQ0FBSSxJQUFJLE1BQUcsQ0FBQyxLQUFLLENBQUMsRUFBM0IsQ0FBMkIsQ0FBQyxDQUM1QyxDQUFDO0lBQ04sQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBRVAsSUFBTSxlQUFlLEdBQUcsQ0FBQztRQUNyQixFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDO1lBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQztRQUNyQyxNQUFNLENBQUMsWUFBWSxDQUFDO0lBQ3hCLENBQUMsQ0FBQyxFQUFFLENBQUM7SUFFTCxJQUFNLFFBQVEsR0FBRywyQkFBWSxDQUFDLGVBQWUsRUFBRTtRQUMzQyxNQUFNLEVBQUUsSUFBSSxFQUFFLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDakQsR0FBRyxLQUFBO1FBQ0gsS0FBSyxPQUFBO1FBQ0wsTUFBTSxRQUFBO1FBQ04sUUFBUSxVQUFBO1FBQ1IsSUFBSSxFQUFFLDBCQUFZLENBQUMsT0FBTztLQUM3QixDQUFDLENBQUM7SUFFSCxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFFMUIsUUFBUSxDQUFDLEVBQUMsSUFBSSxFQUFFLDhCQUFXLENBQUMsUUFBUSxFQUFFLElBQUksRUFBRSxFQUFDLEtBQUssRUFBRSxRQUFRLENBQUMsR0FBRyxFQUFFLE1BQU0sUUFBQSxFQUFFLEtBQUssRUFBRSxrQkFBa0IsRUFBQyxFQUFDLENBQUMsQ0FBQztRQUN2RyxNQUFNLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQVcsQ0FBQztJQUUxQyxDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFDSixJQUFNLFVBQVUsR0FBRztZQUNmLElBQUksRUFBRSxVQUFVO1lBQ2hCLE9BQU8sRUFBRSxrQ0FBa0M7WUFDM0MsSUFBSSxFQUFFLE9BQU87WUFDYixPQUFPLEVBQUUsV0FBVyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUM7WUFDcEMsUUFBUSxFQUFFLFVBQVUsTUFBZ0I7Z0JBQ2hDLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDcEIsTUFBTSxDQUFDLG1DQUFtQyxDQUFDO2dCQUMvQyxDQUFDO2dCQUNELE1BQU0sQ0FBQyxJQUFJLENBQUM7WUFDaEIsQ0FBQztTQUNKLENBQUM7UUFDRixNQUFNLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQVUsUUFBUSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO0lBQzNFLENBQUM7QUFDTCxDQUFDOztBQTlDRCx5QkE4Q0M7QUFFRCxxQkFBNEIsS0FBYTtJQUNyQyxJQUFNLGFBQWEsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyx1QkFBVSxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsRUFBM0IsQ0FBMkIsQ0FBQyxDQUFDO0lBQ3JFLElBQU0sT0FBTyxHQUFTLCtCQUFrQixDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQ3hELElBQU0sR0FBRyxHQUFhLGtCQUFNLENBQUMsYUFBYSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ3JELE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLFVBQUMsS0FBSyxFQUFFLENBQUM7UUFDcEIsTUFBTSxDQUFDO1lBQ0gsSUFBSSxFQUFFLGdCQUFPLENBQUksS0FBSyxDQUFDLENBQUMsQ0FBQyxTQUFJLEtBQUssQ0FBQyxDQUFDLENBQUcsQ0FBQztZQUN4QyxLQUFLLEVBQUUsQ0FBQztnQkFDSixNQUFNLENBQUMsK0JBQWEsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMzQyxDQUFDLENBQUMsRUFBRTtTQUNQLENBQUM7SUFDTixDQUFDLENBQUMsQ0FBQztBQUNQLENBQUM7QUFaRCxrQ0FZQyJ9