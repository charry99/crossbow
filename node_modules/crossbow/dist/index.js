#!/usr/bin/env node
"use strict";
var config_1 = require("./config");
var file_utils_1 = require("./file.utils");
var input_resolve_1 = require("./input.resolve");
var reports = require("./reporter.resolve");
var Rx = require("rx");
var setup_envFile_1 = require("./setup.envFile");
var setup_bin_1 = require("./setup.bin");
var fs = require('fs');
var _ = require("../lodash.custom");
var debug = require("debug")("cb:init");
var availableCommands = {
    run: "./command.run",
    r: "./command.run",
    tasks: "./command.tasks",
    t: "./command.tasks",
    ls: "./command.tasks",
    watch: "./command.watch",
    w: "./command.watch",
    watchers: "./command.watchers",
    init: "./command.init",
    docs: "./command.docs",
};
var isCommand = function (input) { return Object.keys(availableCommands).indexOf(input) > -1; };
/**
 * This the the proxy that allows command/run mode to be handled
 * @param preparedInput
 */
function handleIncoming(preparedInput) {
    var cli = preparedInput.cli, userInput = preparedInput.userInput, config = preparedInput.config, reportFn = preparedInput.reportFn;
    // if the user provided a --cbfile flag, the type 'CBFile'
    // must be available, otherwise this is an error state
    if (userInput.type === input_resolve_1.InputTypes.CBFile) {
        return handleCBfileMode(cli, config, reportFn);
    }
    return processInput(cli, userInput.inputs[0], config, reportFn);
}
exports.handleIncoming = handleIncoming;
function handleCBfileMode(cli, config, reportFn) {
    var createFilePaths = file_utils_1.getRequirePaths(config);
    var input = require(createFilePaths.valid[0].resolved);
    input.default.config = processConfigs(_.merge({}, config, input.default.config), cli.flags);
    input.default.cli = cli;
    input.default.reporter = reportFn;
    if (isCommand(cli.input[0])) {
        return require(availableCommands[cli.input[0]]).default.call(null, cli, input.default, input.default.config, reportFn);
    }
    cli.input = ["run"].concat(cli.input);
    return require(availableCommands["run"]).default.call(null, cli, input.default, input.default.config, reportFn);
}
/**
 * Now decide who should handle the current command
 */
function processInput(cli, input, config, reportFn) {
    var firstArg = cli.input[0];
    return require(availableCommands[firstArg]).default.call(null, cli, input, config, reportFn);
}
function processConfigs(config, flags) {
    var cbConfig = _.merge({}, config, flags);
    return config_1.merge(cbConfig);
}
/**
 * This is the default export that can be
 * used as a convenience method.
 * Note: types are lost when using this method.
 */
var mergeConfigs = function (userInput, merged, flags) {
    return userInput.type !== input_resolve_1.InputTypes.StubInlineObject && userInput.type !== input_resolve_1.InputTypes.CBFile
        ? file_utils_1.Right(config_1.merge(_.merge({}, userInput.inputs[0].config, flags)))
        : file_utils_1.Right(merged);
};
var getConfig = function (flags, input) {
    return file_utils_1.Right(config_1.merge(flags))
        .chain(function (merged) { return getUserInput(merged, input)
        .chain(function (userInput) {
        return mergeConfigs(userInput, merged, flags).map(function (config) { return ({ config: config, userInput: userInput }); });
    }); });
};
var getUserInput = function (merged, input) {
    return file_utils_1.Right(input_resolve_1.getInputs(merged, input))
        .chain(function (userInput) { return userInput.errors.length
        ? file_utils_1.Left({ type: reports.ReportTypes.InputError, data: userInput })
        : file_utils_1.Right(userInput); });
};
var addReporters = function (config) {
    return file_utils_1.Right(reports.getReporters(config))
        .chain(function (reporters) {
        return reporters.invalid.length
            ? file_utils_1.Left({ type: reports.ReportTypes.InvalidReporter, data: { reporters: reporters } })
            : file_utils_1.Right(reporters.valid);
    });
};
var getReportFn = function (reporters) { return function () {
    var args = [];
    for (var _i = 0; _i < arguments.length; _i++) {
        args[_i] = arguments[_i];
    }
    return reporters.forEach(function (x) { return x.callable.apply(null, args); });
}; };
/**
 * Handle any type of init. It could be from the CLI, or via the API.
 * eg, any command from the CLI ultimately ends up in the following call
 *    $  crossbow run task1 -c conf/cb.js
 *    -> handleIncoming({
 *          input: ['run', 'task1'],
 *          flags: {c: 'conf/cb.js'}
 *       });
 */
function getSetup(cli, input) {
    return getConfig(cli.flags, input)
        .chain(function (setup) {
        return setup_bin_1.addBinLookupsToObject(setup.config)
            .chain(function (config) { return setup_envFile_1.addEnvFilesToObject(config); })
            .chain(function (config) { return addReporters(config)
            .map(function (reporters) {
            return {
                reporters: reporters,
                config: config,
                userInput: setup.userInput,
                cli: cli,
                reportFn: getReportFn(reporters)
            };
        }); });
    });
}
exports.getSetup = getSetup;
function default_1(cli, input) {
    return getSetup(cli, input)
        .fold(function (e) {
        return Rx.Observable.just({
            errors: [e]
        });
    }, function (prepared) {
        return handleIncoming(prepared);
    });
}
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = default_1;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFFQSxtQ0FBdUU7QUFDdkUsMkNBQTBEO0FBQzFELGlEQUFpRTtBQUNqRSw0Q0FBOEM7QUFDOUMsdUJBQTBCO0FBRTFCLGlEQUFvRDtBQUNwRCx5Q0FBa0Q7QUFDbEQsSUFBTSxFQUFFLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBRXpCLElBQU0sQ0FBQyxHQUFHLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0FBQ3RDLElBQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQztBQXFCMUMsSUFBTSxpQkFBaUIsR0FBRztJQUN0QixHQUFHLEVBQUUsZUFBZTtJQUNwQixDQUFDLEVBQUUsZUFBZTtJQUNsQixLQUFLLEVBQUUsaUJBQWlCO0lBQ3hCLENBQUMsRUFBRSxpQkFBaUI7SUFDcEIsRUFBRSxFQUFFLGlCQUFpQjtJQUNyQixLQUFLLEVBQUUsaUJBQWlCO0lBQ3hCLENBQUMsRUFBRSxpQkFBaUI7SUFDcEIsUUFBUSxFQUFFLG9CQUFvQjtJQUM5QixJQUFJLEVBQUUsZ0JBQWdCO0lBQ3RCLElBQUksRUFBRSxnQkFBZ0I7Q0FDekIsQ0FBQztBQUVGLElBQU0sU0FBUyxHQUFHLFVBQUMsS0FBSyxJQUFLLE9BQUEsTUFBTSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBbEQsQ0FBa0QsQ0FBQztBQWdCaEY7OztHQUdHO0FBQ0gsd0JBQTJDLGFBQTRCO0lBRTVELElBQUEsdUJBQUcsRUFBRSxtQ0FBUyxFQUFFLDZCQUFNLEVBQUUsaUNBQVEsQ0FBa0I7SUFFekQsMERBQTBEO0lBQzFELHNEQUFzRDtJQUN0RCxFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsSUFBSSxLQUFLLDBCQUFVLENB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