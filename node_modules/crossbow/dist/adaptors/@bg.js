"use strict";
var _npm_1 = require("./@npm");
var task_utils_1 = require("../task.utils");
var debug = require("debug")("cb:@bg");
var merge = require("../../lodash.custom").merge;
function default_1(task, trigger) {
    // todo teardown multiple background emitters on ExitSignal
    //
    var emitter;
    trigger.config.signalObserver.subscribe(function (signal) {
        if (emitter) {
            _npm_1.teardown(emitter, task);
        }
    });
    return function (opts, ctx, done) {
        var args = _npm_1.getArgs(task.command);
        var npmEnv = _npm_1.getEnv(process, trigger.config);
        var cbEnv = task_utils_1.getCBEnv(trigger);
        var ctxEnv = task_utils_1.getContextEnv(trigger, ctx);
        var env = merge({}, process.env, npmEnv, cbEnv, task.env, trigger.config.env, ctxEnv);
        var stdio = _npm_1.getStdio(trigger);
        debug("running %s", args.cmd);
        emitter = _npm_1.runCommand(args.cmd, {
            cwd: trigger.config.cwd,
            env: env,
            stdio: stdio
        });
        emitter.on("close", function (code) {
            _npm_1.teardown(emitter, task);
        }).on("error", function (err) {
            done(err);
        });
        done(null, function tearDownBgAdaptor() {
            _npm_1.teardown(emitter, task);
        });
    };
}
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = default_1;
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQGJnLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2FkYXB0b3JzL0BiZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQ0EsK0JBQXVFO0FBRXZFLDRDQUFzRDtBQUN0RCxJQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDekMsSUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLHFCQUFxQixDQUFDLENBQUMsS0FBSyxDQUFDO0FBRW5ELG1CQUF5QixJQUFVLEVBQUUsT0FBdUI7SUFFeEQsMkRBQTJEO0lBQzNELEVBQUU7SUFDRixJQUFJLE9BQU8sQ0FBQztJQUVaLE9BQU8sQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxVQUFVLE1BQU07UUFDcEQsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztZQUNWLGVBQVEsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDNUIsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsTUFBTSxDQUFDLFVBQVUsSUFBSSxFQUFFLEdBQUcsRUFBRSxJQUFJO1FBRTVCLElBQU0sSUFBSSxHQUFLLGNBQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDckMsSUFBTSxNQUFNLEdBQUcsYUFBTSxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDL0MsSUFBTSxLQUFLLEdBQUkscUJBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNqQyxJQUFNLE1BQU0sR0FBRywwQkFBYSxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQztRQUMzQyxJQUFNLEdBQUcsR0FBTSxLQUFLLENBQUMsRUFBRSxFQUFFLE9BQU8sQ0FBQyxHQUFHLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQzNGLElBQU0sS0FBSyxHQUFJLGVBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUVqQyxLQUFLLENBQUMsWUFBWSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUU5QixPQUFPLEdBQUcsaUJBQVUsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFO1lBQzNCLEdBQUcsRUFBRSxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUc7WUFDdkIsR0FBRyxFQUFFLEdBQUc7WUFDUixLQUFLLEVBQUUsS0FBSztTQUNmLENBQUMsQ0FBQztRQUVILE9BQU8sQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLFVBQVUsSUFBSTtZQUM5QixlQUFRLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzVCLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsVUFBVSxHQUFHO1lBQ3hCLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNkLENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLElBQUksRUFBRTtZQUNQLGVBQVEsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDNUIsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDLENBQUM7QUFDTixDQUFDOztBQXZDRCw0QkF1Q0M7QUFBQSxDQUFDIn0=