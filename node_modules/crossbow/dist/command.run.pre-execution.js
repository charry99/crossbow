"use strict";
var file = require("./file.utils");
var utils = require("./task.utils");
var file_utils_1 = require("./file.utils");
var reporter_resolve_1 = require("./reporter.resolve");
var Rx = require("rx");
var path_1 = require("path");
var config_1 = require("./config");
function createHashes(tasks, trigger) {
    var ifLookups = utils.concatProps(tasks, [], "ifChanged");
    if (!ifLookups.length)
        return Rx.Observable.empty();
    var existingFile = file.readOrCreateJsonFile(path_1.join(".crossbow", "history.json"), trigger.config.cwd);
    if (!existingFile.data.hashes) {
        existingFile.data.hashes = [];
    }
    return file.hashItems(ifLookups, trigger.config.cwd, existingFile.data.hashes)
        .do(function (hashResults) {
        // Write the hashes to disk
        trigger.config.signalObserver.onNext({
            type: config_1.SignalTypes.FileWrite,
            data: {
                file: existingFile,
                content: JSON.stringify({ hashes: hashResults.output }, null, 2)
            }
        });
    })
        .map(function (hashResults) {
        // Send in the marked hashes to the run context
        // so that matching tasks can be ignored
        return {
            "ifChanged": hashResults.markedHashes
        };
    })
        .take(1)
        .catch(function (e) {
        if (e.code === "ENOTDIR")
            e.type = file_utils_1.HashDirErrorTypes.HashNotADirectory;
        if (e.code === "ENOENT")
            e.type = file_utils_1.HashDirErrorTypes.HashPathNotFound;
        trigger.reporter({
            type: reporter_resolve_1.ReportTypes.HashDirError,
            data: {
                error: e,
                cwd: trigger.config.cwd
            }
        });
        return Rx.Observable.just({});
    });
}
exports.createHashes = createHashes;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tbWFuZC5ydW4ucHJlLWV4ZWN1dGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9jb21tYW5kLnJ1bi5wcmUtZXhlY3V0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFFQSxtQ0FBcUM7QUFDckMsb0NBQXNDO0FBQ3RDLDJDQUErQztBQUMvQyx1REFBbUU7QUFDbkUsdUJBQTBCO0FBQzFCLDZCQUEwQjtBQUMxQixtQ0FBcUM7QUFFckMsc0JBQTZCLEtBQWEsRUFBRSxPQUF1QjtJQUUvRCxJQUFNLFNBQVMsR0FBRyxLQUFLLENBQUMsV0FBVyxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFFNUQsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDO1FBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLENBQUM7SUFFcEQsSUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFdBQUksQ0FBQyxXQUFXLEVBQUUsY0FBYyxDQUFDLEVBQUUsT0FBTyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUV0RyxFQUFFLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztRQUM1QixZQUFZLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxFQUFFLENBQUM7SUFDbEMsQ0FBQztJQUVELE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxZQUFZLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQztTQUN6RSxFQUFFLENBQUMsVUFBQyxXQUE4QjtRQUMvQiwyQkFBMkI7UUFDM0IsT0FBTyxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDO1lBQ2pDLElBQUksRUFBRSxvQkFBVyxDQUFDLFNBQVM7WUFDM0IsSUFBSSxFQUFFO2dCQUNGLElBQUksRUFBRSxZQUFZO2dCQUNsQixPQUFPLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFDLE1BQU0sRUFBRSxXQUFXLENBQUMsTUFBTSxFQUFDLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQzthQUNqRTtTQUNKLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQztTQUNELEdBQUcsQ0FBQyxVQUFVLFdBQThCO1FBQ3pDLCtDQUErQztRQUMvQyx3Q0FBd0M7UUFDeEMsTUFBTSxDQUFDO1lBQ0gsV0FBVyxFQUFFLFdBQVcsQ0FBQyxZQUFZO1NBQ3hDLENBQUM7SUFDTixDQUFDLENBQUM7U0FDRCxJQUFJLENBQUMsQ0FBQyxDQUFDO1NBQ1AsS0FBSyxDQUFDLFVBQVUsQ0FBQztRQUVkLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssU0FBUyxDQUFDO1lBQUMsQ0FBQyxDQUFDLElBQUksR0FBRyw4QkFBaUIsQ0FBQyxpQkFBaUIsQ0FBQztRQUN2RSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLFFBQVEsQ0FBQztZQUFFLENBQUMsQ0FBQyxJQUFJLEdBQUcsOEJBQWlCLENBQUMsZ0JBQWdCLENBQUM7UUFFdEUsT0FBTyxDQUFDLFFBQVEsQ0FBQztZQUNiLElBQUksRUFBRSw4QkFBVyxDQUFDLFlBQVk7WUFDOUIsSUFBSSxFQUFFO2dCQUNGLEtBQUssRUFBRSxDQUFDO2dCQUNSLEdBQUcsRUFBRSxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUc7YUFDSjtTQUMxQixDQUFDLENBQUM7UUFFSCxNQUFNLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDbEMsQ0FBQyxDQUFDLENBQUM7QUFDWCxDQUFDO0FBOUNELG9DQThDQyJ9